---
title: "Biostat 203B Homework 2"
subtitle: Due Feb 10 @ 11:59PM
author: Olivia Golston
output: 
  html_document:
    toc: true
    toc_depth: 4 
---

Display machine information for reproducibility:
```{r}
sessionInfo()
```

```{r setup}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
library(tidyverse)
library(data.table)
library(lubridate)
```

```{r}
os <- sessionInfo()$running
if (str_detect(os, "Linux")) {
  mimic_path <- "/usr/203b-data/mimic-iv"
} else if (str_detect(os, "macOS")) {
  mimic_path <- "/Users/huazhou/Documents/Box Sync/MIMIC/mimic-iv-0.4"
}
```

Use tidyverse (ggpot2, dplyr) to explore the [MIMIC-IV](https://mimic-iv.mit.edu) data introduced in [homework 1](https://ucla-biostat203b-2021winter.github.io/hw/hw1/hw1.html).

```{r}
system(str_c("tree -s -L 2 ", shQuote(mimic_path)), intern = TRUE)
```

## Q1. PhysioNet credential

At this moment, you should already get credentialed on the PhysioNet. Please include a screenshot of your `Data Use Agreement for the MIMIC-IV (v0.4)`.

### Solution

![Screenshot of data use agreement](agreement.png)



## Q2. `read.csv` (base R) vs `read_csv` (tidyverse) vs `fread` (data.table)

There are quite a few utilities in R for reading data files. Let us test the speed of reading a moderate sized compressed csv file, `admissions.csv.gz`, by three programs: `read.csv` in base R, `read_csv` in tidyverse, and `fread` in the popular data.table package. Is there any speed difference?

In this homework, we stick to the tidyverse. 

### Solution

The code below records the time required to read in `admissions.csv.gz`. 
```{r message=F}
file_path <- str_c(mimic_path, "/core/admissions.csv.gz")

time1 <- system.time(file1 <- read.csv(file_path))
time2 <- system.time(file2 <- read_csv(file_path))
time3 <- system.time(file3 <- fread(file_path))

```

A comparison of elapsed times are displayed in the table.

Function | Time Elapsed for Execution
-------- | -------------
read.csv | `r time1[3]` 
read_csv | `r time2[3]`
fread    | `r time3[3]`

`read.csv` seems to be the slowest, by far. `read_csv` and `fread` are similar, but `fread` tends to be a slight bit faster.


## Q3. ICU stays

`icustays.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/icu/icustays/>) contains data about Intensive Care Units (ICU) stays. Summarize following variables using appropriate numerics or graphs:   

- how many unique `stay_id`?  
- how many unique `subject_id`?  
- length of ICU stay  
- first ICU unit  
- last ICU unit  

### Solution

First, read in `icustays` data and view the first 10 observations. 
```{r}
icu_stays <- read_csv(str_c(mimic_path, "/icu/icustays.csv.gz")) 

icu_stays %>%
  print()
``` 

Check number of unique `stay_id` values:
```{r}
icu_stays %>% 
  distinct(stay_id) %>%
  nrow()
```
There are 69619 unique `stay_id` values. This is equal to the number of observations in the original dataset, as each observation has been assigned a unique `stay_id` value.  


Check number of unique `subject_id` values:
```{r}
icu_stays %>%
  distinct(subject_id) %>%
  nrow()

```
There are 50048 unique `subject_id` values. This is less than the total number of observations, which means that some individuals have had multiple ICU stays, and are thus present two or more times. 

```{r}
icu_stays %>%
  count(subject_id) %>%
  arrange(desc(n)) 
```
One patient has had 33 ICU stays!


Visualize length of stay. In the initially plot, it appeared that the mass of observations had short stays (less than 30 days), but there were a few extreme outlying values. 
```{r}
icu_stays %>%
  filter(los >= 50) %>%
  arrange(desc(los)) %>%
  select(los)
```
Out of over 69,000 observations, only 112 had stays of 50 days or longer, and only 11 had stays of 100 days or longer. 

To make the graph more interpretable, these outlying values are exluded. 
```{r}
icu_stays %>%
  ggplot(aes(x=los)) +
  geom_histogram(binwidth=.5) +
  coord_cartesian(xlim=c(0,50)) +
  labs(title = "Length of Stay", x = "Length of Stay (days)")
```
It appears that most people stay in the ICU for less than 5 days, and very few stay beyond 10. 


`first_careunit`
```{r}
icu_stays %>%
  ggplot(aes(x=first_careunit)) +
  geom_bar() +
  coord_flip() +
  labs(x = "First Care Unit", title = "First Care Unit during ICU Stay")
```


`last_careunit`
```{r}
icu_stays %>%
  ggplot(aes(x=last_careunit)) +
  geom_bar() +
  coord_flip() +
  labs(x = "Last Care Unit", title = "Last Care Unit during ICU Stay")
```






## Q4. `admission` data

Information of the patients admitted into hospital is available in `ADMISSION.csv.gz`. See <https://mimic-iv.mit.edu/docs/datasets/core/admissions/> for details of each field in this file. Summarize following variables using appropriate graphs. Explain any patterns you observe.   

- admission year  
- admission month  
- admission month day  
- admission week day  
- admission hour (anything unusual?)  
- number of deaths in each year  
- admission type  
- number of admissions per patient  
- admission location  
- discharge location  
- insurance  
- language  
- martial status  
- ethnicity  
- death 

Note it is possible that one patient (uniquely identified by the `SUBJECT_ID`) is admitted into hospital multiple times. When summarizing some demographic information, it makes sense to summarize based on unique patients. 

### Solution
First, we need to read in the admissions data. This dataset will have all admissions.
```{r}
admissions <- read_csv(str_c(mimic_path, "/core/admissions.csv.gz")) 

admissions %>%
  print()
``` 

We also want a filtered version of the data that only contains unique patients, as identified by subject_id.
```{r}
admissions_unique <- admissions %>%
  distinct(subject_id, .keep_all = TRUE) 

admissions_unique %>% 
  print()
```


- admission year  
```{r}
ggplot(data=admissions) +
  geom_bar(aes(year(admittime)))
```


- admission month  
```{r}
ggplot(data=admissions) +
  geom_bar(aes(month(admittime, label=T))) +
  labs(title = "Admissions by Month", x = "Month")
```



- admission month day 
```{r}
ggplot(data=admissions) +
  geom_bar(aes(day(admittime))) +
  labs(title = "Admissions by Day of Month", x = "Day of Month")
```


- admission week day  
```{r}
ggplot(data=admissions) +
  geom_bar(aes(wday(admittime, label=T))) +
  labs(title="Admissions by Day of Week", x="Day of Week")
```

- admission hour (anything unusual?)  
```{r}
ggplot(data=admissions) +
  geom_bar(aes(hour(admittime))) +
  labs(title="Admissions by Hour", x="Hour")
```

- number of deaths in each year  
```{r}
admissions %>%
  filter(!is.na(deathtime)) %>%
  ggplot() +
  geom_bar(aes(year(deathtime)))
```



- admission type  
```{r}
admissions %>%
  ggplot() +
  geom_bar(aes(admission_type)) +
  coord_flip() +
  labs(x = "Admissions Type")
```

- number of admissions per patient  
```{r}
admissions %>%
  count(subject_id) %>%
  ggplot() +
  geom_bar(aes(n)) 
```


- admission location  
```{r}
admissions %>%
  ggplot() +
  geom_bar(aes(admission_location)) +
  coord_flip() +
  labs(x = "Admission Location")
```


- discharge location  
```{r}
admissions %>%
  ggplot() +
  geom_bar(aes(discharge_location)) +
  coord_flip() +
  labs(x = "Discharge Location")
```


- insurance  
```{r}
admissions_unique %>% 
  ggplot() +
  geom_bar(aes(insurance))
```



- language  
```{r}
admissions_unique %>% 
  ggplot() +
  geom_bar(aes(language))
```

- martial status
```{r}
admissions_unique %>% 
  ggplot() +
  geom_bar(aes(marital_status))

```

- ethnicity  
```{r}
admissions_unique %>% 
  ggplot() +
  geom_bar(aes(ethnicity)) +
  coord_flip()
```

- death 
```{r}
admissions %>% 
  group_by(subject_id) %>%
  count(died = sum(!(is.na(deathtime))) > 0) %>%
  ggplot() +
  geom_bar(aes(died))

colnames(admissions_unique)
```

## Q5. `patient` data

Explore `patients.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/core/patients/>) and summarize following variables using appropriate numerics and graphs:  

- `gender`  
- `anchor_age` (explain pattern you see)



```{r}
patients <- read_csv(str_c(mimic_path, "/core/patients.csv.gz")) 


patients %>%
  print()
```


```{r}
patients %>%
  ggplot(aes(x=factor(1), fill = gender)) +
    geom_bar(width=1) +
    coord_polar("y") +
    labs(x = "Gender")
```


```{r}
patients %>%
  ggplot() +
    geom_bar(aes(anchor_age)) 
```
There is a huge spike at 0, and then no observations until ~age 18. Thus, my best guess is that the age of minors is not recorded, to protect privacy. Instead, they all recieve the age "0." After age 18, the ages appear to be coded as normal.  However, there is another spike at the upper end. Perhaps the system can't keep track of 3 digits for age, or they want to protect the privacy of their oldest patients by grouping their ages. 



## Q6. Lab results

`labevents.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/hosp/labevents/>) contains all laboratory measurements for patients. 

We are interested in the lab measurements of creatinine (50912), potassium (50971), sodium (50983), chloride (50902), bicarbonate (50882), hematocrit (51221), white blood cell count (51301), glucose (50931), magnesium (50960), calcium (50893), and lactate (50813). Find the `itemid`s of these lab measurements from `d_labitems.csv.gz` and retrieve a subset of `labevents.csv.gz` only containing these items.


```{r}
temp_path <- "/usr/203b-data/mimic-iv-derived-data"

if(!file.exists("labevents_filtered.csv.gz")) {
    labevents_tble <- fread(str_c(temp_path, "/labevents_filtered_itemid.csv.gz"),
                          header = FALSE,
                          col.names = c("subject_id", 
                                        "hadm_id",
                                        "itemid", 
                                        "charttime", 
                                        "valuenum"),
                          nThread = 4) %>%
    as_tibble() %>%
    mutate_at(c("subject_id", "hadm_id", "itemid"), as.numeric) %>%
    mutate(charttime = ymd_hms(charttime)) 
    
    labevents_tble %>%
      fwrite("labevents_filtered.csv.gz", nThread = 4)
} 

labs <- fread("labevents_filtered.csv.gz", nThread = 1)
```

```{r}
labcodes <- read_csv(str_c(mimic_path, "/hosp/d_labitems.csv.gz")) %>%
  print(width=Inf) 
```

```{r eval=F}
labs <- labs %>%
  filter(itemid %in% c("50912", "50971", "50983", "50902", "50882", "51221", 
                      "51301", "50931", "50960", "50893", "50813")) %>%
  print()

```




## Q7. Vitals from chartered events

We are interested in the vitals for ICU patients: heart rate, mean and systolic blood pressure (invasive and noninvasive measurements combined), body temperature, SpO2, and respiratory rate. Find the `itemid`s of these vitals from `d_items.csv.gz` and retrieve a subset of `chartevents.csv.gz` only containing these items.

`chartevents.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/icu/chartevents/>) contains all the charted data available for a patient. During their ICU stay, the primary repository of a patient’s information is their electronic chart. The `itemid` variable indicates a single measurement type in the database. The `value` variable is the value measured for `itemid`.


`d_items.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/icu/d_items/>) is the dictionary for the `itemid` in `chartevents.csv.gz`. 

### Solution

```{r}
chart_key <- read_csv(str_c(mimic_path, "/icu/d_items.csv.gz")) %>%
  filter(str_detect(label, 'systolic'))

chart_key %>%
  print()
```


```{r}
temp_path <- "/usr/203b-data/mimic-iv-derived-data"

if(!file.exists("chartevents_filtered.csv.gz")) {
    chartevents_tble <- fread(str_c(temp_path, "/chartevents_filtered_itemid.csv.gz"),
                          header = FALSE,
                          col.names = c("subject_id",
                                       "hadm_id",
                                       "stay_id",
                                       "charttime",
                                       "itemid",
                                       "valuenum"),
                          nThread = 4) %>%
    as_tibble() %>%
    mutate_at(c("subject_id", "hadm_id", "stay_id", "itemid"), as.numeric) %>%
    mutate(charttime = ymd_hms(charttime)) %>%
    print(width = Inf)
    
    chartevents_tble %>%
      fwrite("chartevents_filtered.csv.gz", nThread = 4)
    
} 

chart <- fread("chartevents_filtered.csv.gz", nThread = 1)

chart %>% 
  print(width = Inf)
```

## Q8. Putting things together

Let us create a tibble for all ICU stays, where rows are  

- first ICU stay of each unique patient  
- adults (age at admission > 18)  

and columns contain at least following variables  

- all variables in `icustays.csv.gz`  
- all variables in `admission.csv.gz`  
- all variables in `patients.csv.gz`  
- first lab measurements during ICU stay  
- first vitals measurement during ICU stay  
- an indicator variable whether the patient died within 30 days of hospital admission  


```{r eval=F}
data <- icu_stays %>%
  distinct(subject_id, .keep_all=T) %>%
  left_join(patients, by="subject_id") %>%
  filter(anchor_age >= 18) %>%
  left_join(admissions, by=c("hadm_id", "subject_id")) %>% 
  print()

```



