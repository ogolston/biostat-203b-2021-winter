---
title: "Biostat 203B Homework 4"
subtitle: Due Mar 12 @ 11:59PM
author: "Olivia Golston"
output: 
  html_document:
    toc: true
    toc_depth: 4
---

```{r, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```
                      
Display machine information:
```{r}
sessionInfo()
```
Load database libraries and the tidyverse frontend:
```{r}
library(tidyverse)
library(lubridate)
library(miceRanger)
```

## Q1. Missing data

Through the Shiny app developed in HW3, we observe abundant missing values in the MIMIC-IV ICU cohort we created. In this question, we use multiple imputation to obtain a data set without missing values.

0. Read following tutorials on the R package miceRanger for imputation: <https://github.com/farrellday/miceRanger>, <https://cran.r-project.org/web/packages/miceRanger/vignettes/miceAlgorithm.html>.

    A more thorough book treatment of the practical imputation strategies is the book [*_Flexible Imputation of Missing Data_*](https://stefvanbuuren.name/fimd/) by Stef van Buuren. 

### Question 1.1
Explain the jargon MCAR, MAR, and MNAR.

**Solution**

MCAR, MAR, and MNAR are different classifications of missing data.

MCAR stands for Missing Completely at Random. This occurs when there is no systematic pattern in what data is present or missing. In the MIMIC-IV data, an example would be if a lab report got lost by a fluke, so a patient's measurements were missing. It is equally likely that this could happen to any patient, so the data is missing completely at random.

MAR stands for Missing at Random. This is when the missing data is more likely for certain subgroups of the study population, but is random within those groups. For example, it is possible that certain hospital departments are less meticulous about records keeping, so missing values - though completely random within the department - will be more common for patients in that particular department.

MNAR stands for Not Missing at Random. This occurs when the missing values are present due to a non-random mechanism. There are multiple ways this could happen in the MIMIC-IV data:
* Certain labs are only ordered for patients with particular conditions, so healthier patients may tend to have more missing values.
* Unconscious or otherwise incapacitated patients may not be able to provide answers to demographic questions, such as marital status.
* Certain departments may not collect certain pieces of data. 

Understanding which of these 3 classifications applies is necessary when determining how to address the missing data. 

Source: [Stef van Buuren's book](https://stefvanbuuren.name/fimd/sec-MCAR.html)


### Question 1.2
Explain in a couple of sentences how the Multiple Imputation by Chained Equations (MICE) work.

**Solution**

MICE uses available values in a dataset to make the best possible guess about what the missing values would have been.

For the MIMIC-IV data, it will work as follows:

1. Missing values are given a random value - these values will be replaced during the imputation process.
2. For a column of interest (say, `Heart Rate`), the missing values are imputed using the joint correlation between the other variables and `Heart Rate`, using a Random Forest. A person with missing `Heart Rate`, but other lab/chart measurements and demographic characteristics associated with an elevated heart rate will be given a high value.
3. This is repeated for other columns with missing data. 
4. This process (steps 2-3) may be repeated a few times to reach convergence. 


### Question 1.3 
Perform a data quality check of the ICU stays data. Discard variables with substantial missingness, say >5000 `NA`s. Replace apparent data entry errors by `NA`s.

**Solution**

### Question 1.4
Impute missing values by `miceRanger` (request $m=3$ datasets). This step is very computational intensive. Make sure to save the imputation results as a file.

**Solution**


### Question 1.5
Make imputation diagnostic plots and explain what they mean.

**Solution**

### Question 1.6
Obtain a complete data set by averaging the 3 imputed data sets.

**Solution**


## Q2. Predicting 30-day mortality

Develop at least two analytic approaches for predicting the 30-day mortality of patients admitted to ICU using demographic information (gender, age, marital status, ethnicity), first lab measurements during ICU stay, and first vital measurements during ICU stay. For example, you can use (1) logistic regression (`glm()` function), (2) logistic regression with lasso penalty (glmnet package), (3) random forest (randomForest package), or (4) neural network.

1. Partition data into 80% training set and 20% test set. Stratify partitioning according the 30-day mortality status.

2. Train the models using the training set.

3. Compare model prediction performance on the test set.
